## ---- Stage 1: Build ----
FROM node:22.20-bookworm-slim AS builder

ARG NEXT_PUBLIC_VERSION
ENV NEXT_PUBLIC_VERSION=$NEXT_PUBLIC_VERSION

RUN apt-get update && apt-get install -y --no-install-recommends \
    g++ \
    make \
    python3-pip \
    bash \
    && rm -rf /var/lib/apt/lists/*

RUN npm --no-update-notifier --no-fund --global install pnpm@10.6.1

WORKDIR /app
COPY . /app

RUN pnpm install --no-frozen-lockfile
RUN NODE_OPTIONS="--max-old-space-size=4096" pnpm run build

# Remove dev dependencies to shrink node_modules
RUN pnpm prune --prod --no-optional

## ---- Stage 2: Runtime ----
FROM node:22.20-bookworm-slim AS runner

RUN apt-get update && apt-get install -y --no-install-recommends \
    bash \
    nginx \
    && rm -rf /var/lib/apt/lists/*

RUN addgroup --system www \
    && adduser --system --ingroup www --home /www --shell /usr/sbin/nologin www \
    && mkdir -p /www \
    && chown -R www:www /www /var/lib/nginx

RUN npm --no-update-notifier --no-fund --global install pnpm@10.6.1 pm2

# Cap V8 heap for all Node.js processes (frontend, backend, orchestrator)
ENV NODE_OPTIONS="--max-old-space-size=768"

WORKDIR /app

# Copy only what's needed for runtime (no g++, make, python, no devDependencies)
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/pnpm-workspace.yaml ./pnpm-workspace.yaml
COPY --from=builder /app/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=builder /app/apps ./apps
COPY --from=builder /app/libraries ./libraries
COPY --from=builder /app/var ./var

# Copy Nginx config
COPY var/docker/nginx.conf /etc/nginx/nginx.conf

CMD ["sh", "-c", "nginx && pnpm run pm2"]
